/* @license
 *
 * Copyright 2015 ARM Ltd
 */
!function(a,b){"function"==typeof define&&define.amd?define(["jquery"],b):"object"==typeof exports?module.exports=b(require("jquery")):a.mbedCompileApi=b(a.$)}(this,function(a){"use strict";var b="https://developer.mbed.org",c="/api/v2/tasks/compiler/",d=function(a,d){this.logFn=a,this.domain=d||b,this.api=this.domain+c};return d.prototype.setCredentials=function(b,c){var d=b+":"+c;a.ajaxSetup({headers:{Authorization:"Basic "+btoa(d)}})},d.prototype.build=function(b,c,d){var e=[];a(b).find("input").each(function(){var b=a(this),c=b.attr("name"),d=b.attr("type"),f=b.val();"text"===d&&(f='"'+f+'"'),e.push(c+"="+f)});var f={platform:d,repo:this.domain+c,clean:!1,extra_symbols:e.join(",")};this.retryBuild(f)},d.prototype.retryBuild=function(a){this.initiateBuild(a,function(b){b||setTimeout(function(){this.retryBuild(a)}.bind(this),200)}.bind(this))},d.prototype.initiateBuild=function(b,c){a.ajax({url:this.api+"start/",type:"POST",data:b,success:function(a){var b=a.result.data.task_id;this.logFn(b),setTimeout(function(){this.pollProgress(b)}.bind(this),0),c(!0)}.bind(this),error:function(a){500==a.status?c(!1):(this.logFn(a.responseText),c(!0))}.bind(this)})},d.prototype.pollProgress=function(b){a.ajax({url:this.api+"output/"+b,success:function(a){var c=a.result.data.new_messages;for(var d in c){var e=c[d];e.message&&this.logFn(e.type+": "+e.message),e.action&&e.percent?this.logFn(e.action+": "+e.percent):e.action&&this.logFn(e.action+": "+e.file)}a.result.data.task_complete?a.result.data.compilation_success?(this.logFn("success"),this.downloadFile(a.result.data,b)):this.logFn("failed"):setTimeout(function(){this.pollProgress(b)}.bind(this),0)}.bind(this),error:function(a){this.logFn(a.responseText)}.bind(this)})},d.prototype.downloadFile=function(b,c){var d={repomode:!0,program:b.program,binary:b.binary,task_id:c};a.ajax({url:this.api+"bin/",data:d,dataType:"blob",success:function(a,c,d){var e=b.binary,f=d.getResponseHeader("Content-Type"),g=new Blob([a],{type:f});if("undefined"!=typeof window.navigator.msSaveBlob)window.navigator.msSaveBlob(g,e);else{var h=window.URL||window.webkitURL,i=h.createObjectURL(g),j=document.createElement("a");"undefined"==typeof j.download?window.location.href=i:(j.href=i,j.download=e,document.body.appendChild(j),j.click(),setTimeout(function(){h.revokeObjectURL(i)},500))}},error:function(a){this.logFn(a.responseText)}.bind(this)})},a.ajaxTransport("+*",function(a,b,c){return a.dataType&&"blob"==a.dataType?{send:function(b,c){var d=new XMLHttpRequest,e=a.url||window.location.href,f=a.type||"GET",g=a.dataType,h=a.data||null,i=a.async||!0;d.addEventListener("load",function(){var a={};a[g]=d.response,c(d.status,d.statusText,a,d.getAllResponseHeaders())}),d.open(f,e,i);for(var j in b)d.setRequestHeader(j,b[j]);d.responseType=g,d.send(h)},abort:function(){c.abort()}}:void 0}),d});