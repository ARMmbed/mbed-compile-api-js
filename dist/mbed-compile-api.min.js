/* @license
 *
 * Copyright 2015 ARM Ltd
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.mbedCompileApi=b()}(this,function(){"use strict";var a="https://developer.mbed.org",b="/api/v2/tasks/compiler/",c=function(c,d){this.logFn=c,this.domain=d||a,this.api=this.domain+b};return c.prototype.setCredentials=function(a,b){var c=a+":"+b;$.ajaxSetup({headers:{Authorization:"Basic "+btoa(c)}})},c.prototype.build=function(a,b,c){var d=[];$(a).find("input").each(function(){var a=$(this),b=a.attr("name"),c=a.attr("type"),e=a.val();"text"===c&&(e='"'+e+'"'),d.push(b+"="+e)});var e={platform:c,repo:this.domain+"/"+b,clean:!1,extra_symbols:d.join(",")};this.retryBuild(e)},c.prototype.retryBuild=function(a){this.initiateBuild(a,function(b){b||setTimeout(function(){this.retryBuild(a)}.bind(this),200)}.bind(this))},c.prototype.initiateBuild=function(a,b){$.ajax({url:this.api+"start/",type:"POST",data:a,success:function(a){var c=a.result.data.task_id;this.logFn(c),setTimeout(function(){this.pollProgress(c)}.bind(this),0),b(!0)}.bind(this),error:function(a){500==a.status?b(!1):(this.logFn(a.responseText),b(!0))}.bind(this)})},c.prototype.pollProgress=function(a){$.ajax({url:this.api+"output/"+a,success:function(b){var c=b.result.data.new_messages;for(var d in c){var e=c[d];e.message&&this.logFn(e.type+": "+e.message),e.action&&e.percent?this.logFn(e.action+": "+e.percent):e.action&&this.logFn(e.action+": "+e.file)}b.result.data.task_complete?b.result.data.compilation_success?(this.logFn("success"),this.downloadFile(b.result.data,a)):this.logFn("failed"):setTimeout(function(){this.pollProgress(a)}.bind(this),0)}.bind(this),error:function(a){this.logFn(a.responseText)}.bind(this)})},c.prototype.downloadFile=function(a,b){var c={repomode:!0,program:a.program,binary:a.binary,task_id:b};$.ajax({url:this.api+"bin/",data:c,dataType:"blob",success:function(b,c,d){var e=a.binary,f=d.getResponseHeader("Content-Type"),g=new Blob([b],{type:f});if("undefined"!=typeof window.navigator.msSaveBlob)window.navigator.msSaveBlob(g,e);else{var h=window.URL||window.webkitURL,i=h.createObjectURL(g),j=document.createElement("a");"undefined"==typeof j.download?window.location.href=i:(j.href=i,j.download=e,document.body.appendChild(j),j.click(),setTimeout(function(){h.revokeObjectURL(i)},500))}},error:function(a){this.logFn(a.responseText)}.bind(this)})},$.ajaxTransport("+*",function(a,b,c){return a.dataType&&"blob"==a.dataType?{send:function(b,c){var d=new XMLHttpRequest,e=a.url||window.location.href,f=a.type||"GET",g=a.dataType,h=a.data||null,i=a.async||!0;d.addEventListener("load",function(){var a={};a[g]=d.response,c(d.status,d.statusText,a,d.getAllResponseHeaders())}),d.open(f,e,i);for(var j in b)d.setRequestHeader(j,b[j]);d.responseType=g,d.send(h)},abort:function(){c.abort()}}:void 0}),c});